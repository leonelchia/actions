name: Kustomize validation

on:
  pull_request:
    branches:
      - develop
    paths:
      - 'ops/kubernetes/**'
      - '.github/workflows/kustomize-validate.yml'

env:
  KUSTOMIZE_DIRS: |
    ops/kubernetes/overlays/dev
    ops/kubernetes/overlays/stage

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.4.2'

      - name: Install kubeconform
        run: |
          curl -sSLo /tmp/kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar -C /usr/local/bin -xzf /tmp/kubeconform.tar.gz kubeconform

      - name: Build and validate manifests
        run: |
          set -euo pipefail
          for dir in ${KUSTOMIZE_DIRS}; do
            echo "::group::🛠️ Building $dir"

            # Create env files
            touch $dir/-auth.env
            touch $dir/-neo4j.env
            

            kustomize build $dir --enable-helm > /tmp/rendered.yaml
            echo "::endgroup::"

            echo "::group::🔎 Validating $dir"
            kubeconform \
            -strict \
            -schema-location default \
            -ignore-missing-schemas \
            -summary /tmp/rendered.yaml
            echo "::endgroup::"
          done